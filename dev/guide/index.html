<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Theoretical Guide · EvolutionModels.jl</title><meta name="title" content="Theoretical Guide · EvolutionModels.jl"/><meta property="og:title" content="Theoretical Guide · EvolutionModels.jl"/><meta property="twitter:title" content="Theoretical Guide · EvolutionModels.jl"/><meta name="description" content="Documentation for EvolutionModels.jl."/><meta property="og:description" content="Documentation for EvolutionModels.jl."/><meta property="twitter:description" content="Documentation for EvolutionModels.jl."/><meta property="og:url" content="https://mashu.github.io/EvolutionModels.jl/guide/"/><meta property="twitter:url" content="https://mashu.github.io/EvolutionModels.jl/guide/"/><link rel="canonical" href="https://mashu.github.io/EvolutionModels.jl/guide/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">EvolutionModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Theoretical Guide</a><ul class="internal"><li><a class="tocitem" href="#Model-Selection"><span>Model Selection</span></a></li><li><a class="tocitem" href="#Understanding-Distances"><span>Understanding Distances</span></a></li><li><a class="tocitem" href="#Antibody-Sequence-Analysis"><span>Antibody Sequence Analysis</span></a></li><li><a class="tocitem" href="#Likelihood-Computation"><span>Likelihood Computation</span></a></li><li><a class="tocitem" href="#Advanced-Models"><span>Advanced Models</span></a></li><li><a class="tocitem" href="#Limitations-and-Considerations"><span>Limitations and Considerations</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Theoretical Guide</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Theoretical Guide</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/mashu/EvolutionModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/mashu/EvolutionModels.jl/blob/main/docs/src/guide.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Practical-Guide"><a class="docs-heading-anchor" href="#Practical-Guide">Practical Guide</a><a id="Practical-Guide-1"></a><a class="docs-heading-anchor-permalink" href="#Practical-Guide" title="Permalink"></a></h1><p>This guide covers model selection, interpretation of results, and practical applications for antibody sequence analysis.</p><h2 id="Model-Selection"><a class="docs-heading-anchor" href="#Model-Selection">Model Selection</a><a id="Model-Selection-1"></a><a class="docs-heading-anchor-permalink" href="#Model-Selection" title="Permalink"></a></h2><h3 id="DNA-Models"><a class="docs-heading-anchor" href="#DNA-Models">DNA Models</a><a id="DNA-Models-1"></a><a class="docs-heading-anchor-permalink" href="#DNA-Models" title="Permalink"></a></h3><h4 id="JC69-(Jukes-Cantor-1969)"><a class="docs-heading-anchor" href="#JC69-(Jukes-Cantor-1969)">JC69 (Jukes-Cantor 1969)</a><a id="JC69-(Jukes-Cantor-1969)-1"></a><a class="docs-heading-anchor-permalink" href="#JC69-(Jukes-Cantor-1969)" title="Permalink"></a></h4><p>The simplest nucleotide substitution model with equal rates between all bases and uniform base frequencies (π = 0.25 for all).</p><p><strong>Use when:</strong></p><ul><li>Quick distance estimates are needed</li><li>Sequences are closely related (low divergence)</li><li>Base composition is approximately uniform</li></ul><pre><code class="language-julia hljs">model = create_model(JC69Model, 1.0, normalize=true)</code></pre><h4 id="HKY85-(Hasegawa-Kishino-Yano-1985)"><a class="docs-heading-anchor" href="#HKY85-(Hasegawa-Kishino-Yano-1985)">HKY85 (Hasegawa-Kishino-Yano 1985)</a><a id="HKY85-(Hasegawa-Kishino-Yano-1985)-1"></a><a class="docs-heading-anchor-permalink" href="#HKY85-(Hasegawa-Kishino-Yano-1985)" title="Permalink"></a></h4><p>Extends JC69 with a transition/transversion rate ratio (κ) and arbitrary base frequencies.</p><p><strong>Use when:</strong></p><ul><li>Transition bias is expected (common in most biological data)</li><li>Base frequencies differ from uniform</li><li>Analyzing somatic hypermutation in antibodies (κ ≈ 2-3 captures AID bias)</li></ul><pre><code class="language-julia hljs">π = [0.25, 0.25, 0.25, 0.25]  # A, C, G, T frequencies
κ = 2.5  # Transition/transversion ratio
model = create_model(HKY85Model, 1.0, π, κ, normalize=true)</code></pre><h4 id="GTR-(General-Time-Reversible)"><a class="docs-heading-anchor" href="#GTR-(General-Time-Reversible)">GTR (General Time-Reversible)</a><a id="GTR-(General-Time-Reversible)-1"></a><a class="docs-heading-anchor-permalink" href="#GTR-(General-Time-Reversible)" title="Permalink"></a></h4><p>The most general neutral, reversible model with 6 exchangeability parameters and arbitrary base frequencies.</p><p><strong>Use when:</strong></p><ul><li>Full flexibility is required</li><li>Model selection indicates simpler models are inadequate</li><li>Sufficient data exists to estimate additional parameters</li></ul><pre><code class="language-julia hljs">π = [0.3, 0.2, 0.2, 0.3]
rates = [0.0 1.0 2.0 1.0;
         1.0 0.0 1.0 2.0;
         2.0 1.0 0.0 1.0;
         1.0 2.0 1.0 0.0]
model = create_model(GTRModel, 1.0, π, rates, normalize=true)</code></pre><h3 id="Protein-Models"><a class="docs-heading-anchor" href="#Protein-Models">Protein Models</a><a id="Protein-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Protein-Models" title="Permalink"></a></h3><h4 id="LG-(Le-Gascuel-2008)"><a class="docs-heading-anchor" href="#LG-(Le-Gascuel-2008)">LG (Le-Gascuel 2008)</a><a id="LG-(Le-Gascuel-2008)-1"></a><a class="docs-heading-anchor-permalink" href="#LG-(Le-Gascuel-2008)" title="Permalink"></a></h4><p>Empirical amino acid substitution matrix derived from 3,912 protein families. Generally the recommended default for protein sequence analysis.</p><p><strong>Use when:</strong></p><ul><li>Analyzing protein sequences (default choice)</li><li>Antibody VH/VL region analysis</li><li>General protein evolution studies</li></ul><pre><code class="language-julia hljs">model = create_model(LGModel, 1.0, normalize=true)</code></pre><h4 id="WAG-(Whelan-Goldman-2001)"><a class="docs-heading-anchor" href="#WAG-(Whelan-Goldman-2001)">WAG (Whelan-Goldman 2001)</a><a id="WAG-(Whelan-Goldman-2001)-1"></a><a class="docs-heading-anchor-permalink" href="#WAG-(Whelan-Goldman-2001)" title="Permalink"></a></h4><p>Earlier empirical matrix from 182 protein families. Provides an alternative to LG with slightly different exchangeabilities.</p><p><strong>Use when:</strong></p><ul><li>Alternative to LG for comparison</li><li>Consistency with older analyses that used WAG</li></ul><pre><code class="language-julia hljs">model = create_model(WAGModel, 1.0, normalize=true)</code></pre><h3 id="Recommended-Defaults"><a class="docs-heading-anchor" href="#Recommended-Defaults">Recommended Defaults</a><a id="Recommended-Defaults-1"></a><a class="docs-heading-anchor-permalink" href="#Recommended-Defaults" title="Permalink"></a></h3><table><tr><th style="text-align: right">Data Type</th><th style="text-align: right">Model</th><th style="text-align: right">Configuration</th></tr><tr><td style="text-align: right">Protein (simple)</td><td style="text-align: right">LG</td><td style="text-align: right"><code>create_model(LGModel, 1.0, normalize=true)</code></td></tr><tr><td style="text-align: right">Protein (rate variation)</td><td style="text-align: right">LG+G</td><td style="text-align: right"><code>create_gamma_model(base_lg, 1.0)</code></td></tr><tr><td style="text-align: right">Antibodies</td><td style="text-align: right">LG+G or Partition</td><td style="text-align: right">See Antibody section</td></tr><tr><td style="text-align: right">DNA (general)</td><td style="text-align: right">HKY85</td><td style="text-align: right"><code>create_model(HKY85Model, 1.0, π, 2.0, normalize=true)</code></td></tr><tr><td style="text-align: right">DNA (quick estimate)</td><td style="text-align: right">JC69</td><td style="text-align: right"><code>create_model(JC69Model, 1.0, normalize=true)</code></td></tr></table><hr/><h2 id="Understanding-Distances"><a class="docs-heading-anchor" href="#Understanding-Distances">Understanding Distances</a><a id="Understanding-Distances-1"></a><a class="docs-heading-anchor-permalink" href="#Understanding-Distances" title="Permalink"></a></h2><h3 id="Normalized-vs-Unnormalized-Models"><a class="docs-heading-anchor" href="#Normalized-vs-Unnormalized-Models">Normalized vs Unnormalized Models</a><a id="Normalized-vs-Unnormalized-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Normalized-vs-Unnormalized-Models" title="Permalink"></a></h3><p>The <code>normalize=true</code> option scales the rate matrix so that the expected number of substitutions per unit time equals 1. This makes distances directly interpretable.</p><pre><code class="language-julia hljs"># Normalized: distance = expected substitutions per site
model = create_model(LGModel, 1.0, normalize=true)

# Verify normalization
rate = expected_substitution_rate(model.Q, model.π)  # ≈ 1.0</code></pre><p><strong>With normalization</strong>: A distance of 0.1 means approximately 10% of sites have experienced at least one substitution.</p><p><strong>Without normalization</strong>: Distances depend on the model&#39;s inherent scaling and cannot be directly compared across models.</p><h3 id="Distance-Interpretation"><a class="docs-heading-anchor" href="#Distance-Interpretation">Distance Interpretation</a><a id="Distance-Interpretation-1"></a><a class="docs-heading-anchor-permalink" href="#Distance-Interpretation" title="Permalink"></a></h3><table><tr><th style="text-align: right">Distance</th><th style="text-align: right">Sequence Divergence</th><th style="text-align: right">Typical Scenario</th></tr><tr><td style="text-align: right">0.00-0.01</td><td style="text-align: right">Nearly identical</td><td style="text-align: right">Recent duplication, sequencing of same clone</td></tr><tr><td style="text-align: right">0.01-0.05</td><td style="text-align: right">Low divergence</td><td style="text-align: right">Closely related sequences, early divergence</td></tr><tr><td style="text-align: right">0.05-0.15</td><td style="text-align: right">Moderate divergence</td><td style="text-align: right">Typical within-species variation</td></tr><tr><td style="text-align: right">0.15-0.50</td><td style="text-align: right">High divergence</td><td style="text-align: right">Between-species comparisons</td></tr><tr><td style="text-align: right">&gt;0.50</td><td style="text-align: right">Saturated</td><td style="text-align: right">Multiple substitutions obscure signal</td></tr></table><h3 id="Handling-Saturated-Sequences"><a class="docs-heading-anchor" href="#Handling-Saturated-Sequences">Handling Saturated Sequences</a><a id="Handling-Saturated-Sequences-1"></a><a class="docs-heading-anchor-permalink" href="#Handling-Saturated-Sequences" title="Permalink"></a></h3><p>For highly divergent sequences (p-distance &gt; 0.7), distance estimates become unreliable due to multiple substitutions at the same site. Consider:</p><ol><li>Using protein sequences instead of DNA (larger alphabet reduces saturation)</li><li>Focusing on conserved regions</li><li>Interpreting distances with caution</li></ol><hr/><h2 id="Antibody-Sequence-Analysis"><a class="docs-heading-anchor" href="#Antibody-Sequence-Analysis">Antibody Sequence Analysis</a><a id="Antibody-Sequence-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Antibody-Sequence-Analysis" title="Permalink"></a></h2><h3 id="Recommended-Models-for-Antibodies"><a class="docs-heading-anchor" href="#Recommended-Models-for-Antibodies">Recommended Models for Antibodies</a><a id="Recommended-Models-for-Antibodies-1"></a><a class="docs-heading-anchor-permalink" href="#Recommended-Models-for-Antibodies" title="Permalink"></a></h3><p>For antibody sequences, we recommend using rate variation models since CDR and framework regions evolve at very different rates. Full details, parameter guidance, and when to use +G vs partition: <a href="#Advanced-Models">Advanced Models</a>.</p><pre><code class="language-julia hljs"># Option 1: LG+G (simplest, good default)
base = create_model(LGModel, 1.0, normalize=true)
model = create_gamma_model(base, 0.8)  # α=0.8 captures CDR/FR heterogeneity

# Option 2: Partition model (if you know CDR boundaries)
framework = create_model(LGModel, 1.0, normalize=true)
cdr = create_model(LGModel, 2.5, normalize=true)  # CDRs evolve faster
model = create_partition_model(
    1:26 =&gt; framework, 27:38 =&gt; cdr,      # FR1, CDR1
    39:55 =&gt; framework, 56:65 =&gt; cdr,     # FR2, CDR2
    66:104 =&gt; framework, 105:117 =&gt; cdr,  # FR3, CDR3
    118:128 =&gt; framework                   # FR4
)</code></pre><h3 id="Measuring-Somatic-Hypermutation"><a class="docs-heading-anchor" href="#Measuring-Somatic-Hypermutation">Measuring Somatic Hypermutation</a><a id="Measuring-Somatic-Hypermutation-1"></a><a class="docs-heading-anchor-permalink" href="#Measuring-Somatic-Hypermutation" title="Permalink"></a></h3><p>Evolutionary distance between germline and mutated antibody sequences quantifies the extent of somatic hypermutation (SHM).</p><pre><code class="language-julia hljs">using EvolutionModels
using BioSequences
using Optim

# Use Gamma model for better handling of rate variation
base = create_model(LGModel, 1.0, normalize=true)
model = create_gamma_model(base, 1.0)

germline = aa&quot;EVQLVESGGGLVQPGGSLRLSCAASGFTFSSYAMSWVRQAPGKGLEWVSAISGSGGSTYYADSVKGRFTISRDNSKNTLYLQMNSLRAEDTAVYYCAK&quot;
mutated  = aa&quot;EVQLVESGGGLVQPGRSLRLSCAASGFTFSSYWMSWVRQAPGKGLEWVANIKQDGSEKYYVDSVKGRFTISRDNAKNSLYLQMNSLRAEDTAVYYCAK&quot;

# Maximum likelihood distance estimation
neg_ll(t) = t &lt; 0 ? Inf : -sequence_likelihood(model, germline, mutated, t)
result = optimize(neg_ll, 0.0, 1.0, Brent())
distance = Optim.minimizer(result)

println(&quot;SHM distance: $(round(distance, digits=4))&quot;)</code></pre><h3 id="SHM-Distance-Interpretation"><a class="docs-heading-anchor" href="#SHM-Distance-Interpretation">SHM Distance Interpretation</a><a id="SHM-Distance-Interpretation-1"></a><a class="docs-heading-anchor-permalink" href="#SHM-Distance-Interpretation" title="Permalink"></a></h3><table><tr><th style="text-align: right">Distance</th><th style="text-align: right">SHM Level</th><th style="text-align: right">Biological Context</th></tr><tr><td style="text-align: right">0.00-0.02</td><td style="text-align: right">Minimal</td><td style="text-align: right">Near-germline, naive B cell</td></tr><tr><td style="text-align: right">0.02-0.05</td><td style="text-align: right">Low</td><td style="text-align: right">Early memory, limited affinity maturation</td></tr><tr><td style="text-align: right">0.05-0.10</td><td style="text-align: right">Moderate</td><td style="text-align: right">Typical memory B cell</td></tr><tr><td style="text-align: right">0.10-0.15</td><td style="text-align: right">High</td><td style="text-align: right">Extensively matured, long-lived plasma cell</td></tr><tr><td style="text-align: right">&gt;0.15</td><td style="text-align: right">Very high</td><td style="text-align: right">Chronic infection, autoimmune conditions</td></tr></table><h3 id="B-Cell-Lineage-Analysis"><a class="docs-heading-anchor" href="#B-Cell-Lineage-Analysis">B Cell Lineage Analysis</a><a id="B-Cell-Lineage-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#B-Cell-Lineage-Analysis" title="Permalink"></a></h3><p>Computing pairwise distances for clonally-related sequences enables lineage reconstruction and subclone identification.</p><pre><code class="language-julia hljs">using EvolutionModels
using FASTX
using Optim

# Load aligned sequences from a B cell lineage
aln = read_alignment(&quot;bcell_lineage.fasta&quot;)

model = create_model(LGModel, 1.0, normalize=true)
result = compute_distances(model, aln)

# Distance matrix for downstream analysis
D = result.distances
labels = result.labels

print_distance_matrix(result, digits=3)</code></pre><p>The resulting distance matrix can be used for:</p><ul><li>Hierarchical clustering to identify subclones</li><li>Input to tree reconstruction algorithms</li><li>Quantifying within-lineage diversity</li></ul><h3 id="DNA-Level-Analysis"><a class="docs-heading-anchor" href="#DNA-Level-Analysis">DNA-Level Analysis</a><a id="DNA-Level-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#DNA-Level-Analysis" title="Permalink"></a></h3><p>For nucleotide-level analysis capturing SHM transition bias:</p><pre><code class="language-julia hljs">using EvolutionModels
using BioSequences

# HKY85 with transition bias typical of AID-mediated SHM
π = [0.25, 0.25, 0.25, 0.25]
κ = 2.5  # Transitions favored over transversions
model = create_model(HKY85Model, 1.0, π, κ, normalize=true)

germline_nt = dna&quot;GAGGTGCAGCTGGTGGAGTCTGGGGGAGGCTTGGTACAG&quot;
mutated_nt  = dna&quot;GAGGTGCAGCTGGTGGAGTCTGGGGGAGGCTTGGTGCAG&quot;

# Compute likelihood at estimated distance
distance = 0.05
ll = sequence_likelihood(model, germline_nt, mutated_nt, distance)</code></pre><h3 id="Simulating-Sequence-Evolution"><a class="docs-heading-anchor" href="#Simulating-Sequence-Evolution">Simulating Sequence Evolution</a><a id="Simulating-Sequence-Evolution-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-Sequence-Evolution" title="Permalink"></a></h3><p>Generate hypothetical evolved sequences for method validation or hypothesis testing:</p><pre><code class="language-julia hljs">using EvolutionModels
using BioSequences
using Random

Random.seed!(42)

model = create_model(LGModel, 1.0, normalize=true)
germline = aa&quot;EVQLVESGGGLVQPGGSLRLSCAASGFTFSSYAMSWVRQAPGKGLEWVSAISGSGGSTYYADSVKGRFTISRDNSKNTLYLQMNSLRAEDTAVYYCAK&quot;

# Simulate evolution at different distances
for t in [0.02, 0.05, 0.10, 0.15]
    evolved = evolve_sequence(model, germline, t)
    n_mut = count(g != e for (g, e) in zip(germline, evolved))
    println(&quot;t=$t: $n_mut mutations ($(round(100*n_mut/length(germline), digits=1))%)&quot;)
end</code></pre><hr/><h2 id="Likelihood-Computation"><a class="docs-heading-anchor" href="#Likelihood-Computation">Likelihood Computation</a><a id="Likelihood-Computation-1"></a><a class="docs-heading-anchor-permalink" href="#Likelihood-Computation" title="Permalink"></a></h2><h3 id="Conditional-vs-Joint-Likelihood"><a class="docs-heading-anchor" href="#Conditional-vs-Joint-Likelihood">Conditional vs Joint Likelihood</a><a id="Conditional-vs-Joint-Likelihood-1"></a><a class="docs-heading-anchor-permalink" href="#Conditional-vs-Joint-Likelihood" title="Permalink"></a></h3><p>The <code>sequence_likelihood</code> function supports two modes:</p><p><strong>Conditional likelihood</strong> (default):</p><p class="math-container">\[\log P(\text{seq2} | \text{seq1}, t) = \sum_{k=1}^{L} \log P(t)_{x_{1k}, x_{2k}}\]</p><p><strong>Joint likelihood</strong> (<code>joint=true</code>):</p><p class="math-container">\[\log P(\text{seq1}, \text{seq2} | t) = \sum_{k=1}^{L} \left[ \log \pi_{x_{1k}} + \log P(t)_{x_{1k}, x_{2k}} \right]\]</p><pre><code class="language-julia hljs">model = create_model(LGModel, 1.0, normalize=true)
seq1 = aa&quot;EVQLVESGGGLVQPGGSLRL&quot;
seq2 = aa&quot;EVQLVESGGGLIQPGGSLRL&quot;

# Conditional: P(seq2 | seq1, t)
L_cond = sequence_likelihood(model, seq1, seq2, 0.05)

# Joint: P(seq1, seq2 | t)  
L_joint = sequence_likelihood(model, seq1, seq2, 0.05, joint=true)</code></pre><h3 id="When-Joint-Likelihood-Matters"><a class="docs-heading-anchor" href="#When-Joint-Likelihood-Matters">When Joint Likelihood Matters</a><a id="When-Joint-Likelihood-Matters-1"></a><a class="docs-heading-anchor-permalink" href="#When-Joint-Likelihood-Matters" title="Permalink"></a></h3><h4 id="Use-Conditional-(default)-When:"><a class="docs-heading-anchor" href="#Use-Conditional-(default)-When:">Use Conditional (default) When:</a><a id="Use-Conditional-(default)-When:-1"></a><a class="docs-heading-anchor-permalink" href="#Use-Conditional-(default)-When:" title="Permalink"></a></h4><p><strong>Estimating evolutionary distance between two sequences</strong></p><p>The stationary frequency term ∑ log(πᵢ) is constant for fixed sequences regardless of t. Therefore, finding the distance that maximizes likelihood gives the same answer whether you use conditional or joint:</p><pre><code class="language-julia hljs"># Both give the same optimal distance
argmax_t P(seq2|seq1,t) = argmax_t P(seq1,seq2|t)</code></pre><p>For distance estimation, conditional is computationally simpler and equally correct.</p><p><strong>Comparing likelihoods at different times for the same sequence pair</strong></p><p>If you&#39;re asking &quot;is t=0.05 or t=0.10 more likely for these sequences?&quot;, the π term cancels out in the comparison.</p><h4 id="Use-Joint-Likelihood-When:"><a class="docs-heading-anchor" href="#Use-Joint-Likelihood-When:">Use Joint Likelihood When:</a><a id="Use-Joint-Likelihood-When:-1"></a><a class="docs-heading-anchor-permalink" href="#Use-Joint-Likelihood-When:" title="Permalink"></a></h4><p><strong>Comparing different models</strong></p><p>When comparing models with different stationary frequencies (e.g., LG vs WAG, or models with estimated π), the joint likelihood is required for proper comparison:</p><pre><code class="language-julia hljs">model_lg = create_model(LGModel, 1.0, normalize=true)
model_wag = create_model(WAGModel, 1.0, normalize=true)

# WRONG: Conditional doesn&#39;t account for different π
L_lg_cond = sequence_likelihood(model_lg, seq1, seq2, 0.1)
L_wag_cond = sequence_likelihood(model_wag, seq1, seq2, 0.1)

# CORRECT: Joint includes π contribution
L_lg_joint = sequence_likelihood(model_lg, seq1, seq2, 0.1, joint=true)
L_wag_joint = sequence_likelihood(model_wag, seq1, seq2, 0.1, joint=true)

# Model with higher joint likelihood better explains the data
better_model = L_lg_joint &gt; L_wag_joint ? &quot;LG&quot; : &quot;WAG&quot;</code></pre><p><strong>Computing AIC/BIC for model selection</strong></p><p>Information criteria require the actual likelihood, not conditional probability:</p><pre><code class="language-julia hljs"># AIC = 2k - 2ln(L) where L is the likelihood
k = 1  # number of parameters (just distance for empirical models)
AIC_lg = 2*k - 2*L_lg_joint
AIC_wag = 2*k - 2*L_wag_joint</code></pre><p><strong>Bayesian inference</strong></p><p>Posterior probabilities require the joint likelihood:</p><pre><code class="language-julia hljs"># P(model|data) ∝ P(data|model) × P(model)
# P(data|model) is the joint likelihood</code></pre><p><strong>Comparing sequences with different compositions</strong></p><p>If comparing likelihood across different sequence pairs, joint likelihood accounts for how &quot;probable&quot; each sequence is under the model&#39;s equilibrium:</p><pre><code class="language-julia hljs"># Sequence pair A (common amino acids)
seq1a = aa&quot;AAAAAAAAA&quot;
seq2a = aa&quot;AAAAAAAAA&quot;

# Sequence pair B (rare amino acids)  
seq1b = aa&quot;WWWWWWWWW&quot;
seq2b = aa&quot;WWWWWWWWW&quot;

# Conditional treats both equally (identical sequences)
L_a_cond = sequence_likelihood(model, seq1a, seq2a, 0.01)  # High
L_b_cond = sequence_likelihood(model, seq1b, seq2b, 0.01)  # High

# Joint reflects that W is rare in natural proteins
L_a_joint = sequence_likelihood(model, seq1a, seq2a, 0.01, joint=true)
L_b_joint = sequence_likelihood(model, seq1b, seq2b, 0.01, joint=true)
# L_a_joint &gt; L_b_joint because A is more common than W</code></pre><h4 id="Lineage-Reconstruction-and-Clustering"><a class="docs-heading-anchor" href="#Lineage-Reconstruction-and-Clustering">Lineage Reconstruction and Clustering</a><a id="Lineage-Reconstruction-and-Clustering-1"></a><a class="docs-heading-anchor-permalink" href="#Lineage-Reconstruction-and-Clustering" title="Permalink"></a></h4><p>For B cell lineage reconstruction or antibody clustering, use <strong>conditional likelihood</strong> (the default). This is what <code>compute_distances()</code> does internally.</p><p>When computing pairwise distances for a distance matrix:</p><ol><li>Each pair gets its own ML distance estimate</li><li>The π term doesn&#39;t affect which distance is optimal for each pair</li><li>All distances are in the same units and directly comparable</li></ol><pre><code class="language-julia hljs"># Correct approach for lineage/clustering
model = create_model(LGModel, 1.0, normalize=true)
result = compute_distances(model, alignment)
D = result.distances  # Ready for tree building or clustering</code></pre><h4 id="Comparing-Models-for-a-Lineage"><a class="docs-heading-anchor" href="#Comparing-Models-for-a-Lineage">Comparing Models for a Lineage</a><a id="Comparing-Models-for-a-Lineage-1"></a><a class="docs-heading-anchor-permalink" href="#Comparing-Models-for-a-Lineage" title="Permalink"></a></h4><p>If you want to ask &quot;does LG or WAG better explain my antibody lineage?&quot;, use <code>alignment_likelihood</code> to compute total likelihood over all pairs:</p><pre><code class="language-julia hljs">using EvolutionModels
using FASTX
using Optim

aln = read_alignment(&quot;lineage.fasta&quot;)

model_lg = create_model(LGModel, 1.0, normalize=true)
model_wag = create_model(WAGModel, 1.0, normalize=true)

# Compute total joint log-likelihood for each model
result_lg = alignment_likelihood(model_lg, aln)
result_wag = alignment_likelihood(model_wag, aln)

println(&quot;LG:  total=$(round(result_lg.total_logL, digits=2)), mean=$(round(result_lg.mean_logL, digits=2))&quot;)
println(&quot;WAG: total=$(round(result_wag.total_logL, digits=2)), mean=$(round(result_wag.mean_logL, digits=2))&quot;)
println(&quot;Better model: &quot;, result_lg.total_logL &gt; result_wag.total_logL ? &quot;LG&quot; : &quot;WAG&quot;)</code></pre><p>This answers &quot;which substitution model better captures the evolutionary patterns in my antibody data?&quot; - useful when you have lineage-specific amino acid preferences or want to validate model choice.</p><h3 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h3><table><tr><th style="text-align: right">Question</th><th style="text-align: right">Use</th><th style="text-align: right">Reason</th></tr><tr><td style="text-align: right">&quot;What is the evolutionary distance?&quot;</td><td style="text-align: right">Conditional</td><td style="text-align: right">π doesn&#39;t affect optimal t</td></tr><tr><td style="text-align: right">&quot;Distance matrix for clustering/trees?&quot;</td><td style="text-align: right">Conditional</td><td style="text-align: right">Each pair optimized independently</td></tr><tr><td style="text-align: right">&quot;Which model fits better?&quot;</td><td style="text-align: right">Joint</td><td style="text-align: right">Must account for different π</td></tr><tr><td style="text-align: right">&quot;Is this sequence pair unusual?&quot;</td><td style="text-align: right">Joint</td><td style="text-align: right">Accounts for amino acid frequencies</td></tr><tr><td style="text-align: right">&quot;What&#39;s the AIC/BIC?&quot;</td><td style="text-align: right">Joint</td><td style="text-align: right">Information criteria need true likelihood</td></tr><tr><td style="text-align: right">&quot;Posterior probability of model?&quot;</td><td style="text-align: right">Joint</td><td style="text-align: right">Bayesian inference requirement</td></tr></table><h3 id="Maximum-Likelihood-Distance-Estimation"><a class="docs-heading-anchor" href="#Maximum-Likelihood-Distance-Estimation">Maximum Likelihood Distance Estimation</a><a id="Maximum-Likelihood-Distance-Estimation-1"></a><a class="docs-heading-anchor-permalink" href="#Maximum-Likelihood-Distance-Estimation" title="Permalink"></a></h3><p>Find the evolutionary distance that maximizes the likelihood:</p><pre><code class="language-julia hljs">using Optim

model = create_model(LGModel, 1.0, normalize=true)
seq1 = aa&quot;EVQLVESGGGLVQPGGSLRL&quot;
seq2 = aa&quot;EVQLVESGGGLIQPGGSLRL&quot;

neg_ll(t) = t &lt; 0 ? Inf : -sequence_likelihood(model, seq1, seq2, t)
result = optimize(neg_ll, 0.0, 2.0, Brent())

ml_distance = Optim.minimizer(result)
max_logL = -Optim.minimum(result)</code></pre><h3 id="Comparing-Evolutionary-Hypotheses"><a class="docs-heading-anchor" href="#Comparing-Evolutionary-Hypotheses">Comparing Evolutionary Hypotheses</a><a id="Comparing-Evolutionary-Hypotheses-1"></a><a class="docs-heading-anchor-permalink" href="#Comparing-Evolutionary-Hypotheses" title="Permalink"></a></h3><p>Use likelihood ratios to compare different evolutionary scenarios:</p><pre><code class="language-julia hljs">model = create_model(LGModel, 1.0, normalize=true)

# Two sequences
seqA = aa&quot;EVQLVESGGGLVQPGGSLRL&quot;
seqB = aa&quot;EVQLVESGGGLIQPGGSLRL&quot;

# Compare hypotheses: recent vs ancient divergence
L_recent = sequence_likelihood(model, seqA, seqB, 0.02)
L_ancient = sequence_likelihood(model, seqA, seqB, 0.20)

log_ratio = L_recent - L_ancient
println(&quot;Log likelihood ratio: $log_ratio&quot;)
# Positive = recent divergence more likely</code></pre><hr/><h2 id="Advanced-Models"><a class="docs-heading-anchor" href="#Advanced-Models">Advanced Models</a><a id="Advanced-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Models" title="Permalink"></a></h2><p><strong>When to use which:</strong></p><table><tr><th style="text-align: right">Situation</th><th style="text-align: right">Use</th><th style="text-align: right">Example</th></tr><tr><td style="text-align: right">Antibodies, protein (no CDR boundaries)</td><td style="text-align: right"><strong>LG+G</strong></td><td style="text-align: right"><code>create_gamma_model(base_lg, 0.8)</code></td></tr><tr><td style="text-align: right">Antibodies, <strong>DNA</strong> (V region nucleotides)</td><td style="text-align: right"><strong>HKY85+G</strong> or <strong>JC69+G</strong></td><td style="text-align: right"><code>create_gamma_model(base_hky, 1.0)</code></td></tr><tr><td style="text-align: right">Antibodies (CDR/FR boundaries known)</td><td style="text-align: right"><strong>Partition model</strong></td><td style="text-align: right">Different rates for CDR vs framework</td></tr><tr><td style="text-align: right">General proteins with conserved/variable sites</td><td style="text-align: right"><strong>LG+G</strong></td><td style="text-align: right"><code>create_gamma_model(base_lg, 1.0)</code></td></tr><tr><td style="text-align: right">Multi-domain or multi-region sequences</td><td style="text-align: right"><strong>Partition model</strong></td><td style="text-align: right">One model per region</td></tr></table><p>See below for full examples and parameter guidance.</p><h3 id="Gamma-Rate-Variation-(G-Models)"><a class="docs-heading-anchor" href="#Gamma-Rate-Variation-(G-Models)">Gamma Rate Variation (+G Models)</a><a id="Gamma-Rate-Variation-(G-Models)-1"></a><a class="docs-heading-anchor-permalink" href="#Gamma-Rate-Variation-(G-Models)" title="Permalink"></a></h3><p>Real sequences have sites that evolve at different rates - some positions are highly conserved while others are hypervariable. The Gamma model accounts for this by drawing site rates from a discretized Gamma distribution. <strong>+G works with any base model</strong>, including DNA (JC69, HKY85, GTR) and protein (WAG, LG).</p><p><strong>Protein (e.g. antibody amino acid):</strong></p><pre><code class="language-julia hljs"># Create base model
base = create_model(LGModel, 1.0, normalize=true)

# Add Gamma rate variation with 4 categories
# α controls rate variation: smaller = more variation
model = create_gamma_model(base, 0.5)   # High variation
model = create_gamma_model(base, 1.0)   # Moderate variation  
model = create_gamma_model(base, 2.0)   # Low variation</code></pre><p><strong>DNA (e.g. antibody V region nucleotides):</strong> Use HKY85+G to capture both transition bias (SHM) and site-to-site rate variation:</p><pre><code class="language-julia hljs">using EvolutionModels
using BioSequences

π = [0.25, 0.25, 0.25, 0.25]  # A, C, G, T
κ = 2.5   # Transition bias (typical for AID-mediated SHM)
base = create_model(HKY85Model, 1.0, π, κ, normalize=true)
model = create_gamma_model(base, 1.0)  # α=1 for moderate rate variation

germline_nt = dna&quot;GAGGTGCAGCTGGTGGAGTCTGGGGGAGGCTTGGTACAGCCTGGGGGGTCCCTGAGACTCTCCTGTGCAGCCTCT&quot;
mutated_nt  = dna&quot;GAGGTGCAGCTGGTGGAGTCTGGGGGAGGCTTGGTGCAGCCTGGGGGGTCCCTGAGACTCTCCTGTGCAGCCTCT&quot;

logL = sequence_likelihood(model, germline_nt, mutated_nt, 0.05)
evolved = evolve_sequence(model, germline_nt, 0.05)</code></pre><p><strong>When to use:</strong></p><ul><li>Sequences with mix of conserved and variable sites</li><li>Antibody analysis at protein level (CDRs vs frameworks) or DNA level (V region)</li><li>Any analysis where assuming uniform rates seems unrealistic</li></ul><p><strong>Parameter α guidance:</strong></p><table><tr><th style="text-align: right">α value</th><th style="text-align: right">Rate variation</th><th style="text-align: right">Typical use</th></tr><tr><td style="text-align: right">0.3-0.5</td><td style="text-align: right">Very high</td><td style="text-align: right">Highly heterogeneous data</td></tr><tr><td style="text-align: right">0.5-1.0</td><td style="text-align: right">High</td><td style="text-align: right">Antibodies, proteins with functional constraints</td></tr><tr><td style="text-align: right">1.0-2.0</td><td style="text-align: right">Moderate</td><td style="text-align: right">General protein analysis</td></tr><tr><td style="text-align: right">&gt;2.0</td><td style="text-align: right">Low</td><td style="text-align: right">Relatively homogeneous rates</td></tr></table><h3 id="Partition-Models-(Region-Specific-Evolution)"><a class="docs-heading-anchor" href="#Partition-Models-(Region-Specific-Evolution)">Partition Models (Region-Specific Evolution)</a><a id="Partition-Models-(Region-Specific-Evolution)-1"></a><a class="docs-heading-anchor-permalink" href="#Partition-Models-(Region-Specific-Evolution)" title="Permalink"></a></h3><p>For antibodies, CDR and framework regions evolve differently. Partition models apply different evolutionary parameters to different sequence regions.</p><pre><code class="language-julia hljs"># Different models for different regions
framework = create_model(LGModel, 1.0, normalize=true)
cdr = create_model(LGModel, 2.0, normalize=true)  # 2× rate for CDRs

# IMGT numbering example for VH
model = create_partition_model(
    1:26 =&gt; framework,     # FR1
    27:38 =&gt; cdr,          # CDR1
    39:55 =&gt; framework,    # FR2
    56:65 =&gt; cdr,          # CDR2
    66:104 =&gt; framework,   # FR3
    105:117 =&gt; cdr,        # CDR3
    118:128 =&gt; framework   # FR4
)

# Use like any other model
seq1 = aa&quot;...&quot;  # Your antibody sequence
seq2 = aa&quot;...&quot;
logL = sequence_likelihood(model, seq1, seq2, 0.1)</code></pre><p><strong>When to use:</strong></p><ul><li>Antibody sequences with defined CDR/framework boundaries (e.g. IMGT numbering)</li><li>Multi-domain proteins with different evolutionary pressures</li><li>Any sequence with distinct functional regions</li></ul><p><strong>Antibody example with partition model:</strong></p><pre><code class="language-julia hljs">using EvolutionModels
using BioSequences

# Framework and CDR models (CDRs evolve faster)
framework = create_model(LGModel, 1.0, normalize=true)
cdr = create_model(LGModel, 2.5, normalize=true)

model = create_partition_model(
    1:26 =&gt; framework, 27:38 =&gt; cdr,      # FR1, CDR1
    39:55 =&gt; framework, 56:65 =&gt; cdr,     # FR2, CDR2
    66:104 =&gt; framework, 105:117 =&gt; cdr,   # FR3, CDR3
    118:128 =&gt; framework                   # FR4
)

germline = aa&quot;EVQLVESGGGLVQPGGSLRLSCAASGFTFSSYAMSWVRQAPGKGLEWVSAISGSGGSTYYADSVKGRFTISRDNSKNTLYLQMNSLRAEDTAVYYCAK&quot;
mutated  = aa&quot;EVQLVESGGGLVQPGRSLRLSCAASGFTFSSYWMSWVRQAPGKGLEWVANIKQDGSEKYYVDSVKGRFTISRDNAKNSLYLQMNSLRAEDTAVYYCAK&quot;

logL = sequence_likelihood(model, germline, mutated, 0.08)</code></pre><h3 id="Combining-Approaches"><a class="docs-heading-anchor" href="#Combining-Approaches">Combining Approaches</a><a id="Combining-Approaches-1"></a><a class="docs-heading-anchor-permalink" href="#Combining-Approaches" title="Permalink"></a></h3><p>You can use Gamma models as the base for partition models:</p><pre><code class="language-julia hljs"># Framework: conserved, low rate variation
framework_base = create_model(LGModel, 1.0, normalize=true)
framework = create_gamma_model(framework_base, 2.0)  # α=2, low variation

# CDR: hypervariable, high rate variation
cdr_base = create_model(LGModel, 2.0, normalize=true)
cdr = create_gamma_model(cdr_base, 0.5)  # α=0.5, high variation

model = create_partition_model(
    1:26 =&gt; framework,
    27:38 =&gt; cdr,
    # ... etc
)</code></pre><hr/><h2 id="Limitations-and-Considerations"><a class="docs-heading-anchor" href="#Limitations-and-Considerations">Limitations and Considerations</a><a id="Limitations-and-Considerations-1"></a><a class="docs-heading-anchor-permalink" href="#Limitations-and-Considerations" title="Permalink"></a></h2><h3 id="Model-Assumptions"><a class="docs-heading-anchor" href="#Model-Assumptions">Model Assumptions</a><a id="Model-Assumptions-1"></a><a class="docs-heading-anchor-permalink" href="#Model-Assumptions" title="Permalink"></a></h3><p><strong>Basic models</strong> (JC69, HKY85, GTR, WAG, LG) assume:</p><ul><li>Site independence: Each position evolves independently</li><li>Time reversibility: Process is stationary and reversible</li><li>Homogeneous rates: Same process at all sites</li></ul><p><strong>Gamma models</strong> (+G) relax the homogeneous rates assumption by allowing site-specific rate variation.</p><p><strong>Partition models</strong> allow region-specific parameters but still assume independence within each region.</p><h3 id="Empirical-Models-and-SHM"><a class="docs-heading-anchor" href="#Empirical-Models-and-SHM">Empirical Models and SHM</a><a id="Empirical-Models-and-SHM-1"></a><a class="docs-heading-anchor-permalink" href="#Empirical-Models-and-SHM" title="Permalink"></a></h3><p>The WAG and LG matrices were derived from germline protein evolution across diverse protein families. Somatic hypermutation has distinct characteristics:</p><ul><li>AID-mediated with specific hotspot motifs</li><li>Strong selection during affinity maturation</li><li>Rapid timescale (days to weeks vs millions of years)</li></ul><p>The empirical models provide useful approximations but may not perfectly capture SHM patterns. For specialized applications, consider SHM-specific models from the literature.</p><h3 id="Gaps-and-Missing-Data"><a class="docs-heading-anchor" href="#Gaps-and-Missing-Data">Gaps and Missing Data</a><a id="Gaps-and-Missing-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Gaps-and-Missing-Data" title="Permalink"></a></h3><p>Non-standard characters (gaps, ambiguous bases) are excluded from likelihood calculations. Heavily gapped alignments may produce unreliable results. Consider:</p><ul><li>Quality filtering before analysis</li><li>Analyzing gap patterns separately</li><li>Using alignment-free methods for highly divergent sequences</li></ul><hr/><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><ol><li><p>Jukes, T.H. &amp; Cantor, C.R. (1969). Evolution of Protein Molecules. <em>Mammalian Protein Metabolism</em>, 3:21-132.</p></li><li><p>Hasegawa, M., Kishino, H. &amp; Yano, T. (1985). Dating of the human-ape splitting by a molecular clock of mitochondrial DNA. <em>J Mol Evol</em>, 22:160-174.</p></li><li><p>Tavaré, S. (1986). Some probabilistic and statistical problems in the analysis of DNA sequences. <em>Lectures on Mathematics in the Life Sciences</em>, 17:57-86.</p></li><li><p>Whelan, S. &amp; Goldman, N. (2001). A general empirical model of protein evolution derived from multiple protein families using a maximum-likelihood approach. <em>Mol Biol Evol</em>, 18:691-699.</p></li><li><p>Le, S.Q. &amp; Gascuel, O. (2008). An improved general amino acid replacement matrix. <em>Mol Biol Evol</em>, 25:1307-1320.</p></li><li><p>Yang, Z. (2014). <em>Molecular Evolution: A Statistical Approach</em>. Oxford University Press.</p></li><li><p>Yaari, G. &amp; Kleinstein, S.H. (2015). Practical guidelines for B-cell receptor repertoire sequencing analysis. <em>Genome Med</em>, 7:121.</p></li></ol></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Thursday 29 January 2026 09:37">Thursday 29 January 2026</span>. Using Julia version 1.12.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
